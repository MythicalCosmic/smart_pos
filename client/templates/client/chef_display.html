<!DOCTYPE html>
{% load static %}
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Food - Oshxona</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1e1e1e;
            --bg-header: #151515;
            --text-primary: #ffffff;
            --text-muted: #888888;
            --card-color: #e74c3c;
            --success: #27ae60;
            --border-color: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon-small {
            font-size: 1.5rem;
        }

        .order-count-badge {
            background: var(--card-color);
            color: white;
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Color Picker */
        .color-picker-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #252525;
            padding: 4px 10px;
            border-radius: 8px;
        }

        .color-picker-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
        }

        .color-input {
            -webkit-appearance: none;
            appearance: none;
            width: 32px;
            height: 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: transparent;
        }

        .color-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-input::-webkit-color-swatch {
            border: 2px solid #444;
            border-radius: 6px;
        }

        .time {
            font-size: 1.4rem;
            color: var(--text-primary);
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        /* Container */
        .container {
            padding: 16px;
            min-height: calc(100vh - 60px);
        }

        /* Orders Grid - 6 columns */
        .orders-grid {
            column-count: 6;
            column-gap: 12px;
            width: 100%;
        }

        /* ORDER CARD - Dynamic height based on content */
        .order-card {
            background: var(--card-color);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            break-inside: avoid;
            margin-bottom: 12px;
            page-break-inside: avoid;
        }

        .order-card.unpaid {
            outline-offset: -3px;
        }

        /* Card Header */
        .card-header {
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: rgba(0, 0, 0, 0.15);
        }

        .order-number {
            font-size: 1.5rem;
            font-weight: 900;
            color: white;
            line-height: 1;
        }

        .order-meta {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-end;
        }

        .order-time {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.75);
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        /* Order Type */
        .order-type {
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 6px;
            text-transform: uppercase;
            display: inline-block;
            width: fit-content;
        }

        /* Cashier Name - BIG and visible */
        .cashier-name {
            font-size: 1rem;
            font-weight: 800;
            color: white;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 16px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Order Items */
        .order-items {
            padding: 12px 16px;
            flex: 1;
        }

        .order-items::-webkit-scrollbar {
            width: 4px;
        }

        .order-items::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .item {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            flex: 1;
        }

        .item-qty {
            font-size: 1.2rem;
            font-weight: 800;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 14px;
            border-radius: 8px;
            min-width: 50px;
            text-align: center;
        }

        .item-detail {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.8);
            padding-left: 10px;
            border-left: 3px solid rgba(255, 255, 255, 0.4);
            font-style: italic;
        }

        /* Ready Button */
        .btn-ready {
            width: 100%;
            padding: 14px;
            background: var(--success);
            color: var(--text-primary);
            border: none;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-ready:disabled {
            background: rgba(255, 255, 255, 0.5);
            color: #666;
            cursor: not-allowed;
        }

        /* Empty State */
        .empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            color: var(--text-muted);
            text-align: center;
            grid-column: 1 / -1;
        }

        .empty-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Responsive */
        @media (max-width: 1600px) {
            .orders-grid {
                column-count: 5;
            }
        }

        @media (max-width: 1200px) {
            .orders-grid {
                column-count: 4;
            }
        }

        @media (max-width: 900px) {
            .orders-grid {
                column-count: 3;
            }
        }

        @media (max-width: 600px) {
            .orders-grid {
                column-count: 1;
            }

            .header {
                flex-wrap: wrap;
                height: auto;
                padding: 12px;
                gap: 10px;
            }

            .color-picker-label {
                display: none;
            }
        }

        @media (min-width: 2200px) {
            .orders-grid {
                column-count: 7;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <span class="logo-icon-small">üë®‚Äçüç≥</span>
                Smart Food
            </div>
            <div class="order-count-badge" id="orderCount">0 ta</div>
        </div>

        <div class="header-right">
            <div class="color-picker-wrap">
                <span class="color-picker-label">Rang</span>
                <input type="color" class="color-input" id="cardColorInput" value="#e74c3c" title="Karta rangi">
            </div>
            <div class="time" id="time">00:00:00</div>
        </div>
    </header>

    <div class="container">
        <div class="orders-grid" id="orders">
            <div class="empty">
                <div class="empty-icon">üë®‚Äçüç≥</div>
                <div class="empty-text">Buyurtmalar yo'q</div>
            </div>
        </div>
    </div>

    <script>
        const knownOrders = new Set();
        // Store order data with timestamps for smooth timer updates
        const orderData = new Map();
        let isFirstLoad = true;
        let audioCtx = null;

        // Card Color - saves to localStorage
        function setCardColor(color) {
            document.documentElement.style.setProperty('--card-color', color);
            localStorage.setItem('chef-card-color', color);
        }

        document.getElementById('cardColorInput').addEventListener('input', (e) => {
            setCardColor(e.target.value);
        });

        // Load saved color
        const savedCardColor = localStorage.getItem('chef-card-color') || '#e74c3c';
        document.getElementById('cardColorInput').value = savedCardColor;
        setCardColor(savedCardColor);

        function playSound() {
            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                const now = audioCtx.currentTime;
                [0, 0.1, 0.2].forEach((delay, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.setValueAtTime(800 + (i * 200), now + delay);
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.15, now + delay);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + delay + 0.15);
                    osc.start(now + delay);
                    osc.stop(now + delay + 0.15);
                });
            } catch (e) {
                console.log('Sound error:', e);
            }
        }

        function unlockAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.01);
        }

        // Update header clock
        function updateTime() {
            const now = new Date();
            document.getElementById('time').textContent =
                now.toLocaleTimeString('uz-UZ', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Calculate elapsed time from timestamp
        function formatElapsedTime(timestamp) {
            const now = Date.now();
            const orderTime = new Date(timestamp).getTime();
            let seconds = Math.floor((now - orderTime) / 1000);

            if (seconds < 0) seconds = 0;

            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) {
                return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Update all order timers every second - SMOOTH UPDATES
        function updateOrderTimers() {
            const timerElements = document.querySelectorAll('.order-time[data-timestamp]');
            timerElements.forEach(el => {
                const timestamp = el.getAttribute('data-timestamp');
                if (timestamp) {
                    el.textContent = formatElapsedTime(timestamp);
                }
            });
        }
        
        // Run timer updates every second for smooth counting
        setInterval(updateOrderTimers, 1000);

        async function markReady(orderId, btn) {
            btn.disabled = true;
            btn.textContent = '‚è≥ Kutib turing...';

            try {
                const res = await fetch(`{% url "client:chef_mark_ready" order_id=0 %}`.replace('0', orderId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });

                if (res.ok) {
                    const card = btn.closest('.order-card');
                    card.style.transition = 'all 0.4s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        card.remove();
                        knownOrders.delete(orderId);
                        orderData.delete(orderId);
                        updateOrderCount();
                        checkEmpty();
                    }, 400);
                } else {
                    btn.disabled = false;
                    btn.textContent = '‚ùå Xatolik';
                    setTimeout(() => { btn.textContent = '‚úì TAYYOR'; }, 2000);
                }
            } catch (e) {
                console.error(e);
                btn.disabled = false;
                btn.textContent = '‚ùå Xatolik';
                setTimeout(() => { btn.textContent = '‚úì TAYYOR'; }, 2000);
            }
        }

        function updateOrderCount() {
            const count = document.querySelectorAll('.order-card').length;
            document.getElementById('orderCount').textContent = count + ' ta';
        }

        function checkEmpty() {
            if (document.querySelectorAll('.order-card').length === 0) {
                document.getElementById('orders').innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">‚úÖ</div>
                        <div class="empty-text">Barcha buyurtmalar tayyor!</div>
                    </div>
                `;
            }
        }

        const orderTypeMap = {
            HALL: "Zal",
            PICKUP: "Olib ketish",
            DELIVERY: "Yetkazib berish"
        };

        function createOrderCard(order) {
            const items = order.items.map(item => `
                <div class="item">
                    <div class="item-row">
                        <span class="item-name">${item.product_name}</span>
                        <span class="item-qty">√ó${item.quantity}</span>
                    </div>
                    ${item.detail ? `<span class="item-detail">${item.detail}</span>` : ''}
                </div>
            `).join('');

            const unpaidClass = order.is_paid ? '' : 'unpaid';
            
            // Get cashier name from 'user' field
            const cashierName = order.user || '';

            return `
                <div class="order-card ${unpaidClass}" data-id="${order.id}">
                    <div class="card-header">
                        <span class="order-number">#${String(order.display_id).padStart(2, '0')}</span>
                        <div class="order-meta">
                            <span class="order-type">${orderTypeMap[order.order_type] || 'Zal'}</span>
                            <span class="order-time" data-timestamp="${order.created_at}">${formatElapsedTime(order.created_at)}</span>
                        </div>
                    </div>
                    <div class="cashier-name">üë§ ${cashierName}</div>
                    <div class="order-items">
                        ${items}
                    </div>
                    <button class="btn-ready" onclick="markReady(${order.id}, this)">‚úì TAYYOR</button>
                </div>
            `;
        }

        async function fetchOrders() {
            try {
                const res = await fetch('{% url "client:chef_orders_data" %}');
                const data = await res.json();

                let hasNewOrder = false;
                data.orders.forEach(order => {
                    if (!knownOrders.has(order.id) && !isFirstLoad) {
                        hasNewOrder = true;
                    }
                    // Store order data for timer updates
                    orderData.set(order.id, order);
                });

                if (hasNewOrder) {
                    playSound();
                }

                const ordersChanged = data.orders.length !== knownOrders.size ||
                    data.orders.some(o => !knownOrders.has(o.id));

                if (ordersChanged || isFirstLoad) {
                    knownOrders.clear();
                    data.orders.forEach(o => knownOrders.add(o.id));

                    if (data.orders.length > 0) {
                        document.getElementById('orders').innerHTML =
                            data.orders.map(order => createOrderCard(order)).join('');
                    } else {
                        document.getElementById('orders').innerHTML = `
                            <div class="empty">
                                <div class="empty-icon">üë®‚Äçüç≥</div>
                                <div class="empty-text">Buyurtmalar yo'q</div>
                            </div>
                        `;
                    }
                    updateOrderCount();
                }

                isFirstLoad = false;
            } catch (e) {
                console.error(e);
            }
        }

        // Unlock audio on first user interaction
        document.addEventListener('click', function unlockOnce() {
            unlockAudio();
            document.removeEventListener('click', unlockOnce);
        }, { once: true });

        fetchOrders();
        setInterval(fetchOrders, 3000);
    </script>
</body>

</html>